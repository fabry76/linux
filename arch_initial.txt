#Set KB language
loadkeys it.map.gz

##Enable SSH from remote if needed
#Set root password
passwd
#Enable SSH service
systemctl start sshd.service

#Update the system clock
timedatectl set-ntp true

#View disks and partitions
lsblk

#Create 3 partitions
#fdisk /dev/nvme0n1 or cfdisk /dev/nvme0n1

Device             Start       End   Sectors  Size Type
/dev/nvme0n1p1      2048   1050623   1048576  512M EFI System
/dev/nvme0n1p2   1050624 210765823 209715200  100G Linux filesystem
/dev/nvme0n1p3 210765824 500117503 289351680  138G Linux filesystem

#Encrypt and mount partitions

cryptsetup -y -v luksFormat /dev/nvme0n1p2
cryptsetup open /dev/nvme0n1p2 crypthome
mkfs.btrfs /dev/mapper/crypthome
mount --mkdir /dev/mapper/crypthome /mnt/home
cryptsetup -y -v luksFormat /dev/nvme0n1p3
cryptsetup open /dev/nvme0n1p3 cryptroot
mkfs.btrfs /dev/mapper/cryptroot
mount /dev/mapper/cryptroot /mnt
mkfs.fat -F32 /dev/nvme0n1p1
mount --mkdir /dev/nvme0n1p1 /mnt/boot

#Install base system
pacstrap /mnt base base-devel linux-lts linux-lts-headers linux-firmware nano intel-ucode

#Generate fstab
genfstab -U /mnt >> /mnt/etc/fstab

#Change root into the new system:
arch-chroot /mnt /bin/bash

#Set the time zone
ln -sf /usr/share/zoneinfo/Europe/Rome /etc/localtime

#synch hw clock to system clock
hwclock --systohc

#Locale 
nano /etc/locale.gen *(uncomment US and IT)
locale-gen
echo "LANG=en_US.UTF-8" | tee -a /etc/locale.conf

#hostname
echo "arco" | tee -a /etc/hostname

tee -a /etc/hosts  << END
127.0.0.1   localhost
::1         localhost
127.0.1.1   arco.localdomain    arco
END

#packages
pacman -S grub grub-btrfs sbctl efibootmgr networkmanager xdg-user-dirs git

#Netowrk Manager
systemctl enable NetworkManager

# ENCRYPTED
nano /etc/mkinitcpio.conf
*after "block" type "encrypt"
mkinitcpio -p linux-lts

#grub
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB --modules="tpm" --disable-shim-lock
*blkid copy the UUID of the root partition /dev/nvme0n1p3
nano /etc/default/grub
*GRUB_CMDLINE_LINUX="cryptdevice=UUID=xxxxx:cryptroot root=/dev/mapper/cryptroot"
grub-mkconfig -o /boot/grub/grub.cfg

#secure boot keys (RESET SECURE BOOT KEYS FROM BIOS FIRST)
sbctl create-keys
sbctl enroll-keys -m
sbctl sign -s /boot/vmlinuz-linux-lts
sbctl sign -s /boot/EFI/GRUB/grubx64.efi
sbctl verify
sbctl status

#users
useradd -m -G wheel fabri
passwd fabri
EDITOR=nano visudo
*uncomment line %wheel ALL=(ALL:ALL) ALL

#exit and unmount
exit
umount -a
reboot
